---
title: "Web3 的链上基础：共识、状态机与扩容栈"
date: 2020-08-19
categories: [Web3]
tags: [区块链, 共识, Layer2, 状态机]
description: "以“可验证状态机复制”为主线，梳理状态转换、共识与数据可用性（DA），并给出节点/索引/扩容的工程建议与代码片段。"
---

区块链是“可验证状态机复制”（Replicated State Machine）。要把 DApp 做稳，必须理解状态如何被转换、共识如何达成、数据如何被持久化与对外可读。本文从状态机、共识、存储与扩容（L2/DA）出发，构建一条可实践的技术路径，并附带节点与索引的工程建议。

## 1. 状态机与区块
- 交易（Tx）是对状态的变更请求；
- 区块是时间窗口内的交易集合；
- 状态机：`state_{n+1} = transition(state_n, block_txs)`，其中 `transition` 由虚拟机（EVM/WASM）与合约逻辑决定；
- 真实性：通过 Merkle/Patricia Trie/Verkle commitment，为状态/交易/收据生成可校验根。

## 2. 共识算法与容错
- PoW：算力竞争，安全性来源于经济成本与难度调节；
- PoS：权益质押 + 随机选举/委员会 BFT；
- BFT 家族（Tendermint/HotStuff）：低延迟、确定性最终性，容忍 f 个拜占庭节点需总数 ≥ 3f+1；
- 最终性（Finality）：概率型（PoW） vs. 确定性（BFT/PoS 的检查点最终性）；
- 安全-去中心化-性能“铁三角”权衡。

## 3. 存储与索引
- 账户/存储：以太坊账户模型、合约存储槽；
- 索引：事件（logs）作为可订阅变更源；
- 历史访问：归档节点（Erigon）与快照；
- 自建索引：消息队列 + ETL（ClickHouse/PostgreSQL），支持分页、聚合与时间序列；
- 校对：按区块高度对账，处理链重组（reorg）。

## 4. 扩容：Layer2 与数据可用性（DA）
- Rollup：Optimistic（欺诈证明）与 ZK（有效性证明）；
- Validium：链下数据可用性，吞吐更高但信任更强；
- DA 层：Celestia/EigenDA 作为数据发布层，L2 提交证明到 L1；
- 桥接安全：原生桥/轻客户端桥/流动性桥的风险比较。

## 5. 读写路径与最终一致
- 写：`tx -> mempool -> proposer -> block -> consensus`；
- 读：`RPC（视图函数）` + `索引器（事件订阅）`；
- 一致性：UI 上呈现“确认数/最终性状态”，避免用户误解；
- 重组处理：短暂回滚时，索引器需要撤销并重放受影响区块。

## 6. 节点与网络
- 客户端：Geth/Nethermind/Erigon；
- RPC 网关：Infura/Alchemy/self-hosted Nginx 负载；
- P2P：节点发现、区块/交易传播；
- 指标与日志：区块延迟、孤块率、重组率、peer 数量；
- 安全：私钥隔离、远程签名（HSM/Signer）。

## 7. 工程与运维建议
- 多供应商 RPC 容灾，指数退避与幂等机制；
- 节点同步：快速同步/快照/检查点；
- 资源：IO/CPU/网络的均衡，SSD 与队列深度；
- 压测：fork 主网、回放真实负载；
- 成本：根据读写比例选择 L2/缓存/索引器策略。

## 8. 代码与命令片段
- 使用 `ethers.js` 订阅事件并写入数据库：
```js
const provider = new ethers.JsonRpcProvider(RPC)
const iface = new ethers.Interface(abi)
provider.on({ address: CONTRACT, topics: [iface.getEventTopic('Transfer')] }, (log)=>{
  const evt = iface.decodeEventLog('Transfer', log.data, log.topics)
  // 写入数据库，带 blockNumber/txHash，便于去重与回滚
})
```

- Geth 启动与快照：
```bash
geth --http --http.api eth,net,web3 --syncmode snap --datadir /data/geth
```

- Erigon 归档节点（示）：
```bash
erigon --chain mainnet --http --http.api=eth,debug,net,web3 --datadir /data/erigon
```

## 9. 小结
链上是“慢且稳”的全局真相，链下是“快且灵活”的读取与分析。将状态转换、共识与数据可用性理解清楚，配合合理的索引与缓存，才能在可用性与可信度之间取得平衡。选择成熟 L1 + 合适 L2，减少自研链的复杂性，是当下工程落地的主路径。
