---
title: "Web3 浏览器与钱包注入：EIP-1193/6963 与隐私实践"
date: 2023-08-09
categories: [Web3]
tags: [Web3 浏览器, 钱包, EIP-1193, 隐私]
---

Web3 浏览器的要义是“让网页安全地调用用户的加密身份与链上资源”。核心落在 Provider 标准（EIP-1193）、多钱包发现（EIP-6963）与网络切换（EIP-3085/3326），同时还要面对隐私合规、反钓鱼、兼容性与多链适配等现实问题。本文从标准到工程实践，系统讲解如何构建“安全、可靠、好用”的 Web3 浏览器/前端。

## 1. EIP 标准速查
- EIP-1193：Provider 请求/事件接口；
- EIP-6963：多钱包发现与选择；
- EIP-3085：向钱包添加链配置；
- EIP-3326：请求钱包切换链；
- EIP-155（签名交易链ID）、EIP-712（结构化签名）。

常用调用：
```js
await provider.request({ method: 'eth_requestAccounts' })
await provider.request({ method: 'wallet_addEthereumChain', params: [{ chainId:'0x1', rpcUrls:['...'], chainName:'Ethereum', nativeCurrency:{name:'ETH',symbol:'ETH',decimals:18} }] })
await provider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId:'0x1' }] })
```

## 2. 多钱包与注入（EIP-6963）
- 发现：页面监听 `eip6963:announceProvider` 事件，聚合候选；
- 选择：弹出钱包列表，用户选择后注入该 Provider；
- 兼容：Fallback 到 `window.ethereum`。

```js
document.addEventListener('eip6963:announceProvider', (event) => {
  const detail = event.detail; // { info, provider }
  wallets.push(detail)
})
```

## 3. 权限与安全
- 权限最小化：仅在需要时请求账户与签名；
- 白名单域名与签名域隔离（SIWE domain binding）；
- 反钓鱼：明确签名提示含意，拦截 `setApprovalForAll` 弹窗的风险提示；
- Sandboxing：对第三方脚本注入做 CSP 限制；
- 兼容 DNT/隐私：不上传可识别信息，客户端缓存敏感数据。

## 4. 签名与交易
- 登录：SIWE（EIP-4361）签名会话；
- 交易：预估 Gas，失败提示与替代交易；
- 批量与 AA：账户抽象（EIP-4337），用 UserOp 合并多个动作；
- 非 EVM：签名格式差异（Solana/Polkadot），抽象 Provider 层。

## 5. 多链与兼容性矩阵
- EVM 兼容链：主网/L2（Arbitrum/Optimism/zkSync/Linea/Base/...）；
- 非 EVM：通过特定 SDK/适配器；
- 检查清单：链ID、单位、RPC 限流、交易池差异、确认规则；
- 错误处理：网络切换失败/链不支持 → 降级只读。

## 6. 调试与监控
- 调试：启用 `eth_call` 与 `debug_traceTransaction`（权限谨慎）；
- 监控：钱包连接率、签名拒绝率、交易失败率、平均确认时间、非预期链切换次数；
- 前端埋点：区分 Provider 版本、钱包类型（扩展/移动/内嵌）。

## 7. 用户体验优化
- 首屏无需连接钱包（只读模式），用户操作再请求授权；
- 断线重连与会话恢复（SIWE + 短期 token）；
- 错误文案本地化与“下一步指引”；
- 一键复制错误详情到工单；
- 预加载常用合约 ABI 与代币列表；
- 慢链/高拥塞时的友好提示与替代方案（切 L2）。

## 8. 反钓鱼与合规
- 域名与合约白名单：显示“已验证合约/域名”；
- 显示授权范围：`spender`/`tokenId`/`amount`；
- 风险评分：黑名单/社交举报/交易图谱；
- 法务：隐私政策、KYC/AML 适配（若涉及法币出入金）。

## 9. 示例：最小可用多钱包接入
```ts
import { createConfig, http, createStorage } from 'wagmi'
import { injected, walletConnect, coinbaseWallet } from 'wagmi/connectors'

export const config = createConfig({
  chains: [mainnet, arbitrum, optimism],
  transports: {
    [mainnet.id]: http('https://...'),
    [arbitrum.id]: http('https://...')
  },
  connectors: [injected(), walletConnect({ projectId:'...' }), coinbaseWallet({ appName: 'app' })],
  storage: createStorage({ storage: window.localStorage })
})
```

## 10. 小结
一个好的 Web3 浏览器前端，既要“懂标准”也要“懂用户与风控”。以 EIP-1193/6963 为锚点构建 Provider 层，围绕权限/隐私/多链/监控/反钓鱼持续打磨，才能在复杂生态中提供长期可靠的体验。
